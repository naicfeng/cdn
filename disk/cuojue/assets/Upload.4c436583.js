import{b6 as G,_ as J,o as q,d as M,u as K,r as C,bw as N,j as r,y as S,a8 as T,B as O,E as Q,I as L,a3 as _,ad as x,n as X,bf as j,a5 as Y,aS as Z,ac as H,bv as E,bc as U,bx as ee,a9 as te,by as ae,bz as re,bA as ne,p as oe}from"./index.0f8e5364.js";import{a as se,b as le}from"./index.6fdf0ec9.js";async function*ce(a,i,c){const o=new Set;async function u(){const[p,s]=await Promise.race(o);return o.delete(p),s}for(const p of i){const s=(async()=>await c(p,i))().then(l=>[s,l]);o.add(s),o.size>=a&&(yield await u())}for(;o.size;)yield await u()}const ie={pending:"neutral",uploading:"info",backending:"info",success:"success",error:"danger"},de=async a=>{let i=[];const c=async(o,u)=>{await new Promise(s=>{const l=n=>{console.error(n),s({})};if(o.isFile)o.file(n=>{const d=new File([n],u+n.name,{type:n.type});i.push(d),s({})},l);else if(o.isDirectory){const n=o.createReader(),d=()=>{n.readEntries(async g=>{g.length===0&&s({});for(let m=0;m<g.length;m++)await c(g[m],u+o.name+"/");d()},l)};d()}})};return await c(a,""),i},ue=a=>({name:a.name,path:a.webkitRelativePath?a.webkitRelativePath:a.name,size:a.size,progress:0,speed:0,status:"pending"}),pe=async(a,i,c,o=!1)=>{let u=new Date().valueOf(),p=0;const s=new FormData;s.append("file",i);const l=await G.put("/fs/form",s,{headers:{"File-Path":encodeURIComponent(a),"As-Task":o,"Content-Type":"multipart/form-data",Password:J()},onUploadProgress:n=>{if(n.total){const d=n.loaded/n.total*100|0;c("progress",d);const g=new Date().valueOf(),m=(g-u)/1e3;if(m>1){const $=(n.loaded-p)/m;n.total-n.loaded,c("speed",$),u=g,p=n.loaded}d===100&&c("status","backending")}}});if(l.code!==200)return new Error(l.message)},ge=async(a,i,c,o=!1)=>{let u=new Date().valueOf(),p=0;const s=await G.put("/fs/put",i,{headers:{"File-Path":encodeURIComponent(a),"As-Task":o,"Content-Type":i.type||"application/octet-stream",Password:J()},onUploadProgress:l=>{if(l.total){const n=l.loaded/l.total*100|0;c("progress",n);const d=new Date().valueOf(),g=(d-u)/1e3;if(g>1){const y=(l.loaded-p)/g;l.total-l.loaded,c("speed",y),u=d,p=l.loaded}n===100&&c("status","backending")}}});if(s.code!==200)return new Error(s.message)},me=[{name:"Stream",upload:ge,provider:/.*/},{name:"Form",upload:pe,provider:/.*/}],fe=()=>me.filter(a=>a.provider.test(q.provider)),he=a=>{const i=M();return r(_,{w:"$full",spacing:"$1",rounded:"$lg",border:"1px solid $neutral7",alignItems:"start",p:"$2",get _hover(){return{border:`1px solid ${x()}`}},get children(){return[r(U,{css:{wordBreak:"break-all"},get children(){return a.path}}),r(T,{spacing:"$2",get children(){return[r(ee,{get colorScheme(){return ie[a.status]},get children(){return i(`home.upload.${a.status}`)}}),r(U,{get children(){return[te(()=>ae(a.speed)),"/s"]}})]}}),r(re,{w:"$full",trackColor:"$info3",rounded:"$full",get value(){return a.progress},size:"sm",get children(){return r(ne,{get color(){return x()},rounded:"$md"})}}),r(U,{color:"$danger10",get children(){return a.msg}})]}})},ye=()=>{const a=M(),{pathname:i}=K(),[c,o]=C(!1),[u,p]=C(!1),[s,l]=C(!1),[n,d]=N({uploads:[]}),g=()=>n.uploads.every(({status:e})=>["success","error"].includes(e));let m,y;const $=async e=>{if(e.length!==0){p(!0);for(const t of e){const w=ue(t);d("uploads",f=>[...f,w])}for await(const t of ce(3,e,W));}},h=(e,t,w)=>{d("uploads",f=>f.path===e,t,w)},P=fe(),[A,V]=C(P[0]),W=async e=>{const t=e.webkitRelativePath?e.webkitRelativePath:e.name;h(t,"status","uploading");const w=oe(i(),t);try{const f=await A().upload(w,e,(D,F)=>{h(t,D,F)},s());f?(h(t,"status","error"),h(t,"msg",f.message)):(h(t,"status","success"),h(t,"progress",100))}catch(f){console.error(f),h(t,"status","error"),h(t,"msg",f.message)}};return r(_,{w:"$full",pb:"$2",spacing:"$2",get children(){return r(S,{get when(){return!u()},get fallback(){return[r(T,{spacing:"$2",get children(){return[r(O,{colorScheme:"accent",onClick:()=>{d("uploads",e=>e.filter(({status:t})=>!["success","error"].includes(t)))},get children(){return a("home.upload.clear_done")}}),r(S,{get when(){return g()},get children(){return r(O,{onClick:()=>{p(!1)},get children(){return a("home.upload.back")}})}})]}}),r(Q,{get each(){return n.uploads},children:e=>r(he,e)})]},get children(){return[r(L,{type:"file",multiple:!0,ref(e){const t=m;typeof t=="function"?t(e):m=e},display:"none",onChange:e=>{var t;$(Array.from((t=e.target.files)!=null?t:[]))}}),r(L,{type:"file",multiple:!0,webkitdirectory:!0,ref(e){const t=y;typeof t=="function"?t(e):y=e},display:"none",onChange:e=>{var t;$(Array.from((t=e.target.files)!=null?t:[]))}}),r(_,{w:"$full",justifyContent:"center",get border(){return`2px dashed ${c()?x():"$neutral8"}`},rounded:"$lg",onDragOver:e=>{e.preventDefault(),o(!0)},onDragLeave:()=>{o(!1)},onDrop:async e=>{var R,v,z,I;e.preventDefault(),e.stopPropagation(),o(!1);const t=[],w=Array.from((v=(R=e.dataTransfer)==null?void 0:R.items)!=null?v:[]),f=Array.from((I=(z=e.dataTransfer)==null?void 0:z.files)!=null?I:[]);let D=w.length;const F=[];for(let k=0;k<D;k++){const b=w[k].webkitGetAsEntry();b!=null&&b.isFile?t.push(f[k]):b!=null&&b.isDirectory&&F.push(b)}for(const k of F){const B=await de(k);t.push(...B)}t.length===0&&X.warning(a("home.upload.no_files_drag")),$(t)},spacing:"$4",h:"$56",get children(){return r(S,{get when(){return!c()},get fallback(){return r(j,{get children(){return a("home.upload.release")}})},get children(){return[r(j,{get children(){return a("home.upload.upload-tips")}}),r(Y,{w:"30%",get children(){return r(Z,{get value(){return A().name},onChange:e=>{V(P.find(t=>t.name===e))},get options(){return P.map(e=>({label:e.name,value:e.name}))}})}}),r(T,{spacing:"$4",get children(){return[r(H,{compact:!0,size:"xl",get["aria-label"](){return a("home.upload.upload_folder")},colorScheme:"accent",get icon(){return r(se,{})},onClick:()=>{y.click()}}),r(H,{compact:!0,size:"xl",get["aria-label"](){return a("home.upload.upload_files")},get icon(){return r(le,{})},onClick:()=>{m.click()}})]}}),r(E,{get checked(){return s()},onChange:()=>{l(!s())},get children(){return a("home.upload.add_as_task")}})]}})}})]}})}})};export{ye as default};
