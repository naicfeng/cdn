import{b5 as G,_ as J,a0 as q,a as K,b as N,k as C,c2 as Q,e as r,S as U,ad as _,B as M,E as X,I as O,a3 as R,ai as v,n as Y,bK as j,a6 as Z,b8 as E,ah as H,c0 as ee,b1 as T,c3 as te,ae,c4 as re,c5 as ne,c6 as oe,p as se}from"./index.726c3413.js";import{u as le,c as ce,d as ie}from"./index.182af33a.js";async function*de(a,l,u){const n=new Set;async function i(){const[g,c]=await Promise.race(n);return n.delete(g),c}for(const g of l){const c=(async()=>await u(g,l))().then(o=>[c,o]);n.add(c),n.size>=a&&(yield await i())}for(;n.size;)yield await i()}const ue={pending:"neutral",uploading:"info",backending:"info",success:"success",error:"danger"},pe=async a=>{let l=[];const u=async(n,i)=>{await new Promise((c,o)=>{const d=s=>{console.error(s),o(s)};if(n.isFile)n.file(s=>{const p=new File([s],i+s.name,{type:s.type});l.push(p),c({})},d);else if(n.isDirectory){const s=n.createReader(),p=()=>{s.readEntries(async h=>{for(let f=0;f<h.length;f++)await u(h[f],i+n.name+"/");c({}),h.length>0&&p()},d)};p()}})};return await u(a,""),l},ge=a=>({name:a.name,path:a.webkitRelativePath?a.webkitRelativePath:a.name,size:a.size,progress:0,speed:0,status:"pending"}),me=async(a,l,u,n=!1)=>{let i=new Date().valueOf(),g=0;const c=new FormData;c.append("file",l);const o=await G.put("/fs/form",c,{headers:{"File-Path":encodeURIComponent(a),"As-Task":n,"Content-Type":"multipart/form-data","Last-Modified":l.lastModified,Password:J()},onUploadProgress:d=>{if(d.total){const s=d.loaded/d.total*100|0;u("progress",s);const p=new Date().valueOf(),h=(p-i)/1e3;if(h>1){const $=(d.loaded-g)/h;d.total-d.loaded,u("speed",$),i=p,g=d.loaded}s===100&&u("status","backending")}}});if(o.code!==200)return new Error(o.message)},fe=async(a,l,u,n=!1)=>{let i=new Date().valueOf(),g=0;const c=await G.put("/fs/put",l,{headers:{"File-Path":encodeURIComponent(a),"As-Task":n,"Content-Type":l.type||"application/octet-stream","Last-Modified":l.lastModified,Password:J()},onUploadProgress:o=>{if(o.total){const d=o.loaded/o.total*100|0;u("progress",d);const s=new Date().valueOf(),p=(s-i)/1e3;if(p>1){const f=(o.loaded-g)/p;o.total-o.loaded,u("speed",f),i=s,g=o.loaded}d===100&&u("status","backending")}}});if(c.code!==200)return new Error(c.message)},he=[{name:"Stream",upload:fe,provider:/.*/},{name:"Form",upload:me,provider:/.*/}],we=()=>he.filter(a=>a.provider.test(q.provider)),ke=a=>{const l=K();return r(R,{w:"$full",spacing:"$1",rounded:"$lg",border:"1px solid $neutral7",alignItems:"start",p:"$2",get _hover(){return{border:`1px solid ${v()}`}},get children(){return[r(T,{css:{wordBreak:"break-all"},get children(){return a.path}}),r(_,{spacing:"$2",get children(){return[r(te,{get colorScheme(){return ue[a.status]},get children(){return l(`home.upload.${a.status}`)}}),r(T,{get children(){return[ae(()=>re(a.speed)),"/s"]}})]}}),r(ne,{w:"$full",trackColor:"$info3",rounded:"$full",get value(){return a.progress},size:"sm",get children(){return r(oe,{get color(){return v()},rounded:"$md"})}}),r(T,{color:"$danger10",get children(){return a.msg}})]}})},$e=()=>{const a=K(),{pathname:l}=N(),{refresh:u}=le(),[n,i]=C(!1),[g,c]=C(!1),[o,d]=C(!1),[s,p]=Q({uploads:[]}),h=()=>s.uploads.every(({status:e})=>["success","error"].includes(e));let f,$;const P=async e=>{if(e.length!==0){c(!0);for(const t of e){const k=ge(t);p("uploads",m=>[...m,k])}for await(const t of de(3,e,W));u(void 0,!0)}},w=(e,t,k)=>{p("uploads",m=>m.path===e,t,k)},D=we(),[x,V]=C(D[0]),W=async e=>{const t=e.webkitRelativePath?e.webkitRelativePath:e.name;w(t,"status","uploading");const k=se(l(),t);try{const m=await x().upload(k,e,(S,F)=>{w(t,S,F)},o());m?(w(t,"status","error"),w(t,"msg",m.message)):(w(t,"status","success"),w(t,"progress",100))}catch(m){console.error(m),w(t,"status","error"),w(t,"msg",m.message)}};return r(R,{w:"$full",pb:"$2",spacing:"$2",get children(){return r(U,{get when(){return!g()},get fallback(){return[r(_,{spacing:"$2",get children(){return[r(M,{colorScheme:"accent",onClick:()=>{p("uploads",e=>e.filter(({status:t})=>!["success","error"].includes(t)))},get children(){return a("home.upload.clear_done")}}),r(U,{get when(){return h()},get children(){return r(M,{onClick:()=>{c(!1)},get children(){return a("home.upload.back")}})}})]}}),r(X,{get each(){return s.uploads},children:e=>r(ke,e)})]},get children(){return[r(O,{type:"file",multiple:!0,ref(e){const t=f;typeof t=="function"?t(e):f=e},display:"none",onChange:e=>{var t;P(Array.from((t=e.target.files)!=null?t:[]))}}),r(O,{type:"file",multiple:!0,webkitdirectory:!0,ref(e){const t=$;typeof t=="function"?t(e):$=e},display:"none",onChange:e=>{var t;P(Array.from((t=e.target.files)!=null?t:[]))}}),r(R,{w:"$full",justifyContent:"center",get border(){return`2px dashed ${n()?v():"$neutral8"}`},rounded:"$lg",onDragOver:e=>{e.preventDefault(),i(!0)},onDragLeave:()=>{i(!1)},onDrop:async e=>{var A,I,z,B;e.preventDefault(),e.stopPropagation(),i(!1);const t=[],k=Array.from((I=(A=e.dataTransfer)==null?void 0:A.items)!=null?I:[]),m=Array.from((B=(z=e.dataTransfer)==null?void 0:z.files)!=null?B:[]);let S=k.length;const F=[];for(let b=0;b<S;b++){const y=k[b].webkitGetAsEntry();y!=null&&y.isFile?t.push(m[b]):y!=null&&y.isDirectory&&F.push(y)}for(const b of F){const L=await pe(b);t.push(...L)}t.length===0&&Y.warning(a("home.upload.no_files_drag")),P(t)},spacing:"$4",h:"$56",get children(){return r(U,{get when(){return!n()},get fallback(){return r(j,{get children(){return a("home.upload.release")}})},get children(){return[r(j,{get children(){return a("home.upload.upload-tips")}}),r(Z,{w:"30%",get children(){return r(E,{get value(){return x().name},onChange:e=>{V(D.find(t=>t.name===e))},get options(){return D.map(e=>({label:e.name,value:e.name}))}})}}),r(_,{spacing:"$4",get children(){return[r(H,{compact:!0,size:"xl",get["aria-label"](){return a("home.upload.upload_folder")},colorScheme:"accent",get icon(){return r(ce,{})},onClick:()=>{$.click()}}),r(H,{compact:!0,size:"xl",get["aria-label"](){return a("home.upload.upload_files")},get icon(){return r(ie,{})},onClick:()=>{f.click()}})]}}),r(ee,{get checked(){return o()},onChange:()=>{d(!o())},get children(){return a("home.upload.add_as_task")}})]}})}})]}})}})};export{$e as default};
