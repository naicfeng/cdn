import{b4 as q,_ as G,o as W,u as K,q as _,br as N,f as r,x as D,a7 as T,B as O,C as Q,I as L,a2 as x,ba as R,n as S,be as j,a4 as X,bs as Y,ac as H,bp as Z,bb as U,bt as E,a8 as ee,bu as te,bv as ae,bw as re,p as oe}from"./index.f2f1cf32.js";import{u as J}from"./useT.d8472b1f.js";import{a as ne,b as se}from"./index.dd0e2162.js";async function*le(a,c,i){const n=new Set;async function u(){const[p,s]=await Promise.race(n);return n.delete(p),s}for(const p of c){const s=(async()=>await i(p,c))().then(l=>[s,l]);n.add(s),n.size>=a&&(yield await u())}for(;n.size;)yield await u()}const ie={pending:"neutral",uploading:"info",backending:"info",success:"success",error:"danger"},ce=async a=>{let c=[];const i=async(n,u)=>{await new Promise(s=>{const l=o=>{console.error(o),s({})};if(n.isFile)n.file(o=>{const d=new File([o],u+o.name,{type:o.type});c.push(d),s({})},l);else if(n.isDirectory){const o=n.createReader(),d=()=>{o.readEntries(async m=>{m.length===0&&s({});for(let f=0;f<m.length;f++)await i(m[f],u+n.name+"/");d()},l)};d()}})};return await i(a,""),c},de=a=>({name:a.name,path:a.webkitRelativePath?a.webkitRelativePath:a.name,size:a.size,progress:0,speed:0,status:"pending"}),ue=async(a,c,i,n=!1)=>{let u=new Date().valueOf(),p=0;const s=new FormData;s.append("file",c);const l=await q.put("/fs/form",s,{headers:{"File-Path":encodeURIComponent(a),"As-Task":n,"Content-Type":"multipart/form-data",Password:G()},onUploadProgress:o=>{if(o.total){const d=o.loaded/o.total*100|0;i("progress",d);const m=new Date().valueOf(),f=(m-u)/1e3;if(f>1){const k=(o.loaded-p)/f;o.total-o.loaded,i("speed",k),u=m,p=o.loaded}d===100&&i("status","backending")}}});if(l.code!==200)return new Error(l.message)},pe=async(a,c,i,n=!1)=>{let u=new Date().valueOf(),p=0;const s=await q.put("/fs/put",await c.arrayBuffer(),{headers:{"File-Path":encodeURIComponent(a),"As-Task":n,"Content-Type":c.type||"application/octet-stream",Password:G()},onUploadProgress:l=>{if(l.total){const o=l.loaded/l.total*100|0;i("progress",o);const d=new Date().valueOf(),m=(d-u)/1e3;if(m>1){const y=(l.loaded-p)/m;l.total-l.loaded,i("speed",y),u=d,p=l.loaded}o===100&&i("status","backending")}}});if(s.code!==200)return new Error(s.message)},me=[{name:"Stream",upload:pe,provider:/.*/},{name:"Form",upload:ue,provider:/.*/}],fe=()=>me.filter(a=>a.provider.test(W.provider)),ge=a=>{const c=J();return r(x,{w:"$full",spacing:"$1",rounded:"$lg",border:"1px solid $neutral7",alignItems:"start",p:"$2",get _hover(){return{border:`1px solid ${R()}`}},get children(){return[r(U,{css:{wordBreak:"break-all"},get children(){return a.path}}),r(T,{spacing:"$2",get children(){return[r(E,{get colorScheme(){return ie[a.status]},get children(){return c(`home.upload.${a.status}`)}}),r(U,{get children(){return[ee(()=>te(a.speed)),"/s"]}})]}}),r(ae,{w:"$full",trackColor:"$info3",rounded:"$full",get value(){return a.progress},size:"sm",get children(){return r(re,{get color(){return R()},rounded:"$md"})}}),r(U,{color:"$danger10",get children(){return a.msg}})]}})},ke=()=>{const a=J(),{pathname:c}=K(),[i,n]=_(!1),[u,p]=_(!1),[s,l]=_(!1),[o,d]=N({uploads:[]}),m=()=>o.uploads.every(({status:e})=>["success","error"].includes(e));let f,y;const k=async e=>{if(e.length!==0){p(!0);for(const t of e){const w=de(t);d("uploads",g=>[...g,w])}for await(const t of le(3,e,V));}},h=(e,t,w)=>{d("uploads",g=>g.path===e,t,w)},P=fe(),[v,M]=_(P[0]),V=async e=>{const t=e.webkitRelativePath?e.webkitRelativePath:e.name;h(t,"status","uploading");const w=oe(c(),t);try{const g=await v().upload(w,e,($,F)=>{h(t,$,F)},s());g?(h(t,"status","error"),h(t,"msg",g.message)):(h(t,"status","success"),h(t,"progress",100))}catch(g){console.error(g),h(t,"status","error"),h(t,"msg",g.message)}};return r(x,{w:"$full",pb:"$2",spacing:"$2",get children(){return r(D,{get when(){return!u()},get fallback(){return[r(T,{spacing:"$2",get children(){return[r(O,{colorScheme:"accent",onClick:()=>{d("uploads",e=>e.filter(({status:t})=>!["success","error"].includes(t)))},get children(){return a("home.upload.clear_done")}}),r(D,{get when(){return m()},get children(){return r(O,{onClick:()=>{p(!1)},get children(){return a("home.upload.back")}})}})]}}),r(Q,{get each(){return o.uploads},children:e=>r(ge,e)})]},get children(){return[r(L,{type:"file",multiple:!0,ref(e){const t=f;typeof t=="function"?t(e):f=e},display:"none",onChange:e=>{var t;k(Array.from((t=e.target.files)!=null?t:[]))}}),r(L,{type:"file",multiple:!0,webkitdirectory:!0,ref(e){const t=y;typeof t=="function"?t(e):y=e},display:"none",onChange:e=>{var t;k(Array.from((t=e.target.files)!=null?t:[]))}}),r(x,{w:"$full",justifyContent:"center",get border(){return`2px dashed ${i()?R():"$neutral8"}`},rounded:"$lg",onDragOver:e=>{e.preventDefault(),n(!0)},onDragLeave:()=>{n(!1)},onDrop:async e=>{var A,I,z,B;e.preventDefault(),e.stopPropagation(),n(!1);const t=[],w=Array.from((I=(A=e.dataTransfer)==null?void 0:A.items)!=null?I:[]),g=Array.from((B=(z=e.dataTransfer)==null?void 0:z.files)!=null?B:[]);let $=0,F=w.length;for(let C=0;C<F;C++){if($>0){S.warning(a("home.upload.only_files_or_one_folder"));return}const b=w[C].webkitGetAsEntry();b!=null&&b.isFile?t.push(g[C]):b!=null&&b.isDirectory&&(t.push(...await ce(b)),$++)}if($>0&&F>1){S.warning(a("home.upload.only_files_or_one_folder"));return}t.length===0&&S.warning(a("home.upload.no_files_drag")),k(t)},spacing:"$4",h:"$56",get children(){return r(D,{get when(){return!i()},get fallback(){return r(j,{get children(){return a("home.upload.release")}})},get children(){return[r(j,{get children(){return a("home.upload.upload-tips")}}),r(X,{w:"30%",get children(){return r(Y,{get value(){return v().name},onChange:e=>{M(P.find(t=>t.name===e))},get options(){return P.map(e=>({label:e.name,value:e.name}))}})}}),r(T,{spacing:"$4",get children(){return[r(H,{compact:!0,size:"xl",get["aria-label"](){return a("home.upload.upload_folder")},colorScheme:"accent",get icon(){return r(ne,{})},onClick:()=>{y.click()}}),r(H,{compact:!0,size:"xl",get["aria-label"](){return a("home.upload.upload_files")},get icon(){return r(se,{})},onClick:()=>{f.click()}})]}}),r(Z,{get checked(){return s()},onChange:()=>{l(!s())},get children(){return a("home.upload.add_as_task")}})]}})}})]}})}})};export{ke as default};
